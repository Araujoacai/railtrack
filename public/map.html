<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RealTrack â€“ Mapa ao Vivo</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0a0e1a">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="css/style.css" />
</head>

<body class="map-page">

    <!-- â”€â”€ Mapa â”€â”€ -->
    <div id="map"></div>

    <!-- â”€â”€ Banner de Modo DireÃ§Ã£o â”€â”€ -->
    <div class="drive-banner" id="driveBanner">
        <div class="drive-banner-icon" id="driveNavIcon">â¬†ï¸</div>
        <div class="drive-banner-info">
            <div class="drive-banner-dist" id="driveNavDist">--- m</div>
            <div class="drive-banner-text" id="driveNavText">Siga em frente</div>
        </div>
    </div>

    <!-- â”€â”€ Painel lateral â”€â”€ -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <div class="panel-logo">ğŸ“ RealTrack</div>
            <button class="panel-toggle" id="panelToggle" onclick="togglePanel()" title="Recolher painel">â—€</button>
        </div>

        <!-- CÃ³digo da sala -->
        <div class="room-code-box">
            <div class="room-code-left">
                <div class="room-code-label">CÃ³digo da sala</div>
                <div class="room-code-value" id="roomCodeDisplay">------</div>
            </div>
            <button class="btn-copy" id="btnCopy" onclick="copyCode()">ğŸ“‹ Copiar</button>
        </div>

        <!-- Status GPS -->
        <div class="gps-status" id="gpsStatus">
            <div class="gps-dot" id="gpsDot"></div>
            <span id="gpsText">Aguardando GPS...</span>
        </div>

        <!-- NavegaÃ§Ã£o (visÃ­vel apenas para host) -->
        <div class="nav-section" id="navSection" style="display:none">
            <div class="section-title">ğŸ§­ Navegar <span class="host-badge" id="hostBadge">AnfitriÃ£o</span></div>
            <div class="nav-search-row">
                <input type="text" id="destSearch" placeholder="Para onde?" maxlength="200"
                    onkeydown="if(event.key==='Enter') searchDestination()" />
                <button onclick="searchDestination()" title="Buscar">ğŸ”</button>
            </div>
            <div class="nav-results" id="navResults" style="display:none"></div>
            <p class="hint" id="navHint">Ou <a href="#" onclick="enableMapClick(); return false;"
                    style="color:var(--accent);">clique no mapa</a> para definir o destino.</p>
        </div>

        <!-- DireÃ§Ãµes (todos veem quando hÃ¡ destino) -->
        <div class="directions-section" id="directionsSection" style="display:none">
            <div class="section-title">
                ğŸ“‹ DireÃ§Ãµes
                <button class="btn-cancel-dest" onclick="clearDestination()" title="Cancelar destino">âœ•</button>
            </div>
            <div class="dest-info" id="destInfo"></div>
            <div class="directions-list" id="directionsList"></div>
        </div>

        <!-- UsuÃ¡rios -->
        <div class="users-section">
            <div class="section-title">UsuÃ¡rios na sala <span class="user-count" id="userCount">0</span></div>
            <div class="users-list" id="usersList"></div>
        </div>

        <!-- Chat -->
        <div class="chat-section">
            <div class="section-title">Chat</div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-row">
                <input type="text" id="chatInput" placeholder="Mensagem..." maxlength="200"
                    onkeydown="if(event.key==='Enter') sendMessage()" />
                <button onclick="sendMessage()">â¤</button>
            </div>
        </div>

        <!-- BotÃµes de aÃ§Ã£o -->
        <div class="panel-actions">
            <button class="btn-fuel" onclick="openFuelModal()">â›½ Calcular</button>
            <button class="btn-leave" onclick="leaveRoom()">ğŸšª Sair</button>
        </div>
    </div>

    <!-- â”€â”€ BotÃ£o flutuante (painel recolhido) â”€â”€ -->
    <button class="fab-panel" id="fabPanel" onclick="togglePanel()" style="display:none" title="Abrir painel">â˜°</button>

    <!-- â”€â”€ BotÃ£o centralizar â”€â”€ -->
    <button class="fab-center" onclick="centerMap()" title="Centralizar no meu local">Centralizar</button>

    <!-- â”€â”€ BotÃ£o radares/pedÃ¡gios â”€â”€ -->
    <button class="fab-tomtom active" id="btnToggleTomTom" onclick="toggleOverpass()" title="Radares e PedÃ¡gios">ğŸ“·
        Radares: ON</button>

    <!-- â”€â”€ BotÃ£o de tema claro/escuro â”€â”€ -->
    <button class="fab-theme" id="btnTheme" onclick="toggleMapTheme()" title="Alternar tema">ğŸŒ™</button>

    <!-- â”€â”€ Controles de Modo DireÃ§Ã£o â”€â”€ -->
    <div class="drive-controls">
        <button class="btn-drive-fab" onclick="map.zoomIn()" title="Aumentar Zoom">+</button>
        <button class="btn-drive-fab" onclick="map.zoomOut()" title="Diminuir Zoom">âˆ’</button>
    </div>

    <!-- â”€â”€ Alternar Modo DireÃ§Ã£o â”€â”€ -->
    <button class="fab-drive-toggle" id="btnDriveToggle" onclick="toggleDriveMode()" title="Modo DireÃ§Ã£o">
        ğŸš—
    </button>


    <!-- â”€â”€ Modal de CÃ¡lculo de Viagem â”€â”€ -->
    <div class="fuel-modal-overlay hidden" id="fuelModal" onclick="if(event.target===this) closeFuelModal()">
        <div class="fuel-modal-box">
            <div class="fuel-modal-header">
                <span>â›½ Calcular Viagem</span>
                <button class="fuel-modal-close" onclick="closeFuelModal()">âœ•</button>
            </div>

            <div class="fuel-modal-route" id="fuelRouteInfo">
                <span id="fuelRouteDist">-- km</span>
                <span id="fuelRouteTolls">-- pedÃ¡gios</span>
            </div>

            <div class="fuel-fields">
                <div class="fuel-field-group">
                    <label for="fuelPrice">PreÃ§o do combustÃ­vel (R$/litro)</label>
                    <input type="number" id="fuelPrice" min="0" step="0.01" placeholder="Ex: 6.50" />
                </div>
                <div class="fuel-field-group">
                    <label for="fuelConsumption">Consumo do veÃ­culo (km/litro)</label>
                    <input type="number" id="fuelConsumption" min="0" step="0.1" placeholder="Ex: 12.5" />
                </div>
                <div class="fuel-field-group">
                    <label for="fuelTollValue">Valor estimado por pedÃ¡gio (R$)</label>
                    <input type="number" id="fuelTollValue" min="0" step="0.50" placeholder="Ex: 8.00" />
                </div>
            </div>

            <button class="btn-fuel-calc" onclick="calculateFuelCost()">Calcular</button>

            <div class="fuel-result" id="fuelResult" style="display:none">
                <div class="fuel-result-grid">
                    <div class="fuel-result-item">
                        <span class="fuel-result-label">ğŸ›£ï¸ DistÃ¢ncia</span>
                        <span class="fuel-result-value" id="resDistance">--</span>
                    </div>
                    <div class="fuel-result-item">
                        <span class="fuel-result-label">â›½ CombustÃ­vel</span>
                        <span class="fuel-result-value" id="resFuel">--</span>
                    </div>
                    <div class="fuel-result-item">
                        <span class="fuel-result-label">ğŸš§ PedÃ¡gios</span>
                        <span class="fuel-result-value" id="resTolls">--</span>
                    </div>
                    <div class="fuel-result-item fuel-result-total">
                        <span class="fuel-result-label">ğŸ’° Total estimado</span>
                        <span class="fuel-result-value" id="resTotal">--</span>
                    </div>
                </div>
                <p class="fuel-disclaimer">* PedÃ¡gios sÃ£o estimados pelos postos detectados prÃ³ximos Ã  rota. Valores
                    reais podem variar.</p>
            </div>
        </div>
    </div>

    <!-- â”€â”€ Toast de notificaÃ§Ãµes â”€â”€ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- â”€â”€ Modal de permissÃ£o GPS â”€â”€ -->
    <div class="modal-overlay hidden" id="gpsModal">
        <div class="modal-box">
            <div class="modal-icon">ğŸ“¡</div>
            <h2>PermissÃ£o de GPS</h2>
            <p>Para compartilhar sua localizaÃ§Ã£o em tempo real, precisamos acessar o GPS do seu dispositivo.</p>
            <p class="modal-note">Sua localizaÃ§Ã£o serÃ¡ compartilhada apenas com os usuÃ¡rios desta sala.</p>
            <button class="btn-primary" onclick="requestGPS()">âœ… Permitir GPS</button>
            <button class="btn-secondary" onclick="denyGPS()">âŒ NÃ£o permitir</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Plugin de rotaÃ§Ã£o do mapa -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/map.js"></script>
</body>

</html>